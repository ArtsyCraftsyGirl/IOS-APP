workflows:
  ios-workflow:
    name: iOS Workflow
    max_build_duration: 120
    integrations:
      app_store_connect: Codemagic
    environment:
      xcode: latest
      ios_signing:
        distribution_type: app_store
        bundle_identifier: com.jbpaladinpatriotsclock.jbpaladinpatriotsclock
      vars:
        APP_STORE_APPLE_ID: "XAJF22HXCQ"
        XCODE_WORKSPACE: "platforms/ios/JbPaladinPatriotsClock.xcworkspace"
        XCODE_SCHEME: "JbPaladinPatriotsClock"
    scripts:
      - name: Install Dependencies
        script: |
          npm install
          npm install -g cordova
          cordova platform add ios --no-interactive

      - name: Set iOS Deployment Target to 12.0
        script: |
          /usr/libexec/PlistBuddy -c "Set :MinimumOSVersion 12.0" platforms/ios/*/Info.plist

      - name: Install CocoaPods and Dependencies
        script: |
          cd platforms/ios && pod install --repo-update

      - name: Create build.json for Code Signing
        script: |
          echo '{
            "ios": {
              "developmentTeam": "XAJF22HXCQ",
              "codeSignIdentity": "iPhone Distribution",
              "provisioningProfile": "JbPaladinPatriotsClock Distribution Profile",
              "packageType": "app-store"
            }
          }' > build.json

      - name: Verify Signing Identities
        script: |
          security find-identity -p codesigning -v

      - name: Build iOS App
        script: |
          cordova build ios --device --release --buildConfig=./build.json

      - name: Create Export Options for Xcode
        script: |
          echo '<?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>XAJF22HXCQ</string>
            <key>uploadBitcode</key>
            <true/>
            <key>compileBitcode</key>
            <true/>
          </dict>
          </plist>' > exportOptions.plist

      - name: Export .ipa file
        script: | 
          xcodebuild -exportArchive \
                     -archivePath platforms/ios/build/device/JbPaladinPatriotsClock.xcarchive \
                     -exportOptionsPlist exportOptions.plist \
                     -exportPath platforms/ios/build/device/ \
                     -allowProvisioningUpdates

    artifacts:
      - platforms/ios/build/device/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM
